{% extends "base.html" %}

{% block title %}Datenbank rücksichern - Maschinengemeinschaft{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <h1 class="text-white mb-4">
            <i class="bi bi-arrow-counterclockwise"></i> Datenbank rücksichern
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle-fill"></i> Datenbank-Wiederherstellung
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-danger">
                    <h6><i class="bi bi-exclamation-triangle-fill"></i> WARNUNG - Bitte aufmerksam lesen!</h6>
                    <ul class="mb-0">
                        <li><strong>Alle aktuellen Daten werden überschrieben!</strong></li>
                        <li>Daten nach dem Backup-Zeitpunkt gehen verloren</li>
                        <li>Die aktuelle Datenbank wird automatisch gesichert</li>
                        <li>Nach der Wiederherstellung muss die Anwendung neu gestartet werden</li>
                        <li>Nur für Haupt-Administratoren verfügbar</li>
                    </ul>
                </div>

                <h6 class="mt-4">Voraussetzungen:</h6>
                <div class="alert alert-info">
                    <ol class="mb-0">
                        <li>Stellen Sie sicher, dass alle Benutzer abgemeldet sind</li>
                        <li>Wählen Sie eine gültige Backup-Datei (*.db)</li>
                        <li>Die Backup-Datei muss vom selben System erstellt worden sein</li>
                        <li>Nach erfolgreicher Wiederherstellung die Anwendung neu starten</li>
                    </ol>
                </div>

                <form method="POST" enctype="multipart/form-data" onsubmit="return confirm('ACHTUNG: Möchten Sie wirklich die Datenbank wiederherstellen? Alle aktuellen Daten werden überschrieben!');">
                    <div class="mb-4">
                        <label for="backup_file" class="form-label">
                            <i class="bi bi-file-earmark-arrow-up"></i> Backup-Datei auswählen
                        </label>
                        <input type="file" 
                               class="form-control" 
                               id="backup_file" 
                               name="backup_file" 
                               accept=".db"
                               required>
                        <small class="text-muted">
                            Erlaubte Dateiformate: .db (SQLite Datenbank)
                        </small>
                    </div>

                    <div class="mb-4">
                        <div class="form-check">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="confirm_restore" 
                                   required>
                            <label class="form-check-label" for="confirm_restore">
                                <strong>Ich verstehe, dass alle aktuellen Daten überschrieben werden</strong>
                            </label>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-danger btn-lg">
                            <i class="bi bi-arrow-counterclockwise"></i> Datenbank jetzt wiederherstellen
                        </button>
                        <a href="{{ url_for('admin_system.admin_dashboard') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Abbrechen
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle"></i> Hinweise
                </h6>
            </div>
            <div class="card-body">
                <h6>Backup erstellen:</h6>
                <p class="small">
                    Bevor Sie eine Wiederherstellung durchführen, sollten Sie ein aktuelles Backup erstellen:
                </p>
                <a href="{{ url_for('admin_system.admin_database_backup') }}" class="btn btn-primary btn-sm w-100 mb-3">
                    <i class="bi bi-download"></i> Backup herunterladen
                </a>

                <hr>

                <h6>Schritte nach Wiederherstellung:</h6>
                <ol class="small mb-0">
                    <li>Alle Benutzer neu anmelden lassen</li>
                    <li>Daten überprüfen</li>
                    <li>Ggf. fehlende Einsätze nacherfassen</li>
                    <li>Neue Backup-Bestätigung durchführen</li>
                </ol>

                <hr>

                <h6>Bei Problemen:</h6>
                <p class="small mb-0">
                    Die alte Datenbank wird automatisch gesichert mit Zeitstempel. Sie können diese manuell wiederherstellen falls etwas schief geht.
                </p>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header bg-warning">
                <h6 class="mb-0">
                    <i class="bi bi-shield-lock"></i> Sicherheit
                </h6>
            </div>
            <div class="card-body">
                <p class="small mb-0">
                    Diese Funktion ist nur für <strong>Haupt-Administratoren</strong> zugänglich. Jede Wiederherstellung wird protokolliert.
                </p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3 mb-5">
    <div class="col-12">
        <a href="{{ url_for('admin_system.admin_dashboard') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Zurück zum Dashboard
        </a>
    </div>
</div>

{% endblock %}
