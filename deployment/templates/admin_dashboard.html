{% extends "base.html" %}

{% block title %}Admin-Dashboard - Maschinengemeinschaft{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <h1 class="text-white mb-4">
            <i class="bi bi-shield-lock"></i> Administrator-Dashboard
        </h1>
    </div>
</div>

<!-- Backup-Warnung -->
{% if offene_bestaetigung %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <h5 class="alert-heading">
                <i class="bi bi-hourglass-split"></i> Backup-Bestätigung ausstehend
            </h5>
            {% if offene_bestaetigung.ist_eigene %}
            <p class="mb-2">
                Sie haben eine Backup-Durchführung bestätigt.<br>
                <strong>Warten auf Bestätigung eines zweiten Administrators.</strong>
            </p>
            <p class="mb-0">
                <small class="text-muted">
                    Ihre Bestätigung: {{ offene_bestaetigung.zeitpunkt }}<br>
                    {% if offene_bestaetigung.bemerkung %}
                    Bemerkung: {{ offene_bestaetigung.bemerkung }}
                    {% endif %}
                </small>
            </p>
            {% else %}
            <p class="mb-2">
                <strong>{{ offene_bestaetigung.admin_name }}</strong> hat eine Backup-Durchführung bestätigt.<br>
                Bitte bestätigen Sie ebenfalls die Durchführung, um das Backup abzuschließen.
            </p>
            <p class="mb-0">
                <small class="text-muted">
                    Bestätigung von: {{ offene_bestaetigung.admin_name }} um {{ offene_bestaetigung.zeitpunkt }}<br>
                    {% if offene_bestaetigung.bemerkung %}
                    Bemerkung: {{ offene_bestaetigung.bemerkung }}
                    {% endif %}
                </small>
            </p>
            <hr>
            <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#backupModal">
                <i class="bi bi-check-circle"></i> Zweite Bestätigung abgeben
            </button>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

{% if backup_warnung %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <h5 class="alert-heading">
                <i class="bi bi-exclamation-triangle-fill"></i> Datensicherung empfohlen!
            </h5>
            <p class="mb-2">
                Es wurden <strong>{{ einsaetze_seit_backup }} neue Einsätze</strong> seit der letzten Datensicherung erfasst.
                {% if letztes_backup %}
                Letztes Backup: <strong>{{ letztes_backup }}</strong>
                {% endif %}
            </p>
            <p class="mb-2">
                <small class="text-muted">
                    Ihr Backup-Schwellwert: <strong>{{ backup_schwellwert }} Einsätze</strong>
                    <a href="{{ url_for('auth.passwort_aendern') }}" class="text-decoration-none">
                        <i class="bi bi-gear"></i> ändern
                    </a>
                </small>
            </p>
            <hr>
            <p class="mb-3">
                <small>
                    <i class="bi bi-info-circle"></i> 
                    Bitte erstellen Sie ein Backup der Datenbank <code>maschinengemeinschaft.db</code> und bestätigen Sie die Durchführung.
                </small>
            </p>
            <p class="mb-2">
                <small class="text-warning">
                    <i class="bi bi-people-fill"></i> 
                    <strong>Zwei-Personen-Regel:</strong> Ein zweiter Administrator muss die Sicherung ebenfalls bestätigen.
                </small>
            </p>
            <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#backupModal">
                <i class="bi bi-check-circle"></i> Backup durchgeführt - bestätigen
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- Statistik-Karten -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Benutzer</p>
                        <h3 class="mb-0">{{ benutzer|length }}</h3>
                    </div>
                    <i class="bi bi-people" style="font-size: 2.5rem; color: #667eea;"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Maschinen</p>
                        <h3 class="mb-0">{{ maschinen|length }}</h3>
                    </div>
                    <i class="bi bi-tools" style="font-size: 2.5rem; color: #667eea;"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Gesamt Einsätze</p>
                        <h3 class="mb-0">{{ stats.gesamt_einsaetze or 0 }}</h3>
                    </div>
                    <i class="bi bi-calendar-check" style="font-size: 2.5rem; color: #667eea;"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Gesamt Stunden</p>
                        <h3 class="mb-0">{{ "%.0f"|format(stats.gesamt_stunden or 0) }}</h3>
                    </div>
                    <i class="bi bi-clock-history" style="font-size: 2.5rem; color: #667eea;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Schnellzugriff -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center p-4">
                <i class="bi bi-list-check" style="font-size: 3rem; color: #667eea;"></i>
                <h5 class="mt-3">Alle Einsätze</h5>
                <p class="text-muted">Übersicht aller Maschineneinsätze</p>
                <a href="{{ url_for('admin_system.admin_alle_einsaetze') }}" class="btn btn-primary">
                    <i class="bi bi-eye"></i> Anzeigen
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center p-4">
                <i class="bi bi-people" style="font-size: 3rem; color: #667eea;"></i>
                <h5 class="mt-3">Benutzerverwaltung</h5>
                <p class="text-muted">Benutzer anzeigen und verwalten</p>
                <a href="{{ url_for('admin_benutzer.admin_benutzer') }}" class="btn btn-primary">
                    <i class="bi bi-eye"></i> Anzeigen
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center p-4">
                <i class="bi bi-tools" style="font-size: 3rem; color: #667eea;"></i>
                <h5 class="mt-3">Maschinenverwaltung</h5>
                <p class="text-muted">Maschinen anzeigen und verwalten</p>
                <a href="{{ url_for('admin_maschinen.admin_maschinen') }}" class="btn btn-primary">
                    <i class="bi bi-eye"></i> Anzeigen
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center p-4">
                <i class="bi bi-tag" style="font-size: 3rem; color: #667eea;"></i>
                <h5 class="mt-3">Einsatzzwecke</h5>
                <p class="text-muted">Einsatzzwecke verwalten</p>
                <a href="{{ url_for('admin_einsatzzwecke.admin_einsatzzwecke') }}" class="btn btn-primary">
                    <i class="bi bi-eye"></i> Anzeigen
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-body text-center p-4">
                <i class="bi bi-people-fill" style="font-size: 3rem; color: #667eea;"></i>
                <h5 class="mt-3">Gemeinschaften</h5>
                <p class="text-muted">Gemeinschaften verwalten</p>
                <a href="{{ url_for('admin_gemeinschaften.admin_gemeinschaften') }}" class="btn btn-primary">
                    <i class="bi bi-eye"></i> Anzeigen
                </a>
            </div>
        </div>
    </div>
                    <i class="bi bi-eye"></i> Anzeigen
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Daten-Export / Backup -->
<div class="row mt-3 mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-download"></i> Daten-Export & Backup
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Laden Sie alle Daten herunter oder erstellen Sie ein vollständiges Backup der Datenbank.</p>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('admin_system.admin_export_json') }}" class="btn btn-outline-primary">
                        <i class="bi bi-file-earmark-code"></i> Export als JSON
                    </a>
                    <a href="{{ url_for('admin_system.admin_export_csv') }}" class="btn btn-outline-primary">
                        <i class="bi bi-file-earmark-spreadsheet"></i> Export als CSV (ZIP)
                    </a>
                    <a href="{{ url_for('admin_system.admin_database_backup') }}" class="btn btn-outline-success">
                        <i class="bi bi-database"></i> Datenbank-Backup
                    </a>
                    <a href="{{ url_for('admin_system.admin_export_alle_einsaetze_csv') }}" class="btn btn-outline-info">
                        <i class="bi bi-file-earmark-spreadsheet-fill"></i> Alle Einsätze als CSV
                    </a>
                    <a href="{{ url_for('admin_system.admin_replication') }}" class="btn btn-outline-warning">
                        <i class="bi bi-arrow-repeat"></i> Replication
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Einsätze löschen -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle-fill"></i> Datenbereinigung (Jahresende)
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-3">
                    <strong>ACHTUNG:</strong> Hier können Sie alte Einsätze permanent löschen (z.B. am Jahresende).
                    <br>
                    <span class="text-danger">Erstellen Sie vorher unbedingt ein Backup!</span>
                </p>
                <a href="{{ url_for('admin_system.admin_einsaetze_loeschen') }}" class="btn btn-danger">
                    <i class="bi bi-trash-fill"></i> Einsätze nach Zeitraum löschen
                </a>
                <div class="alert alert-warning mt-3 mb-0">
                    <i class="bi bi-info-circle"></i> 
                    <strong>Hinweis:</strong> Das Datenbank-Backup enthält alle Daten inklusive Passwörter (gehashed) und kann zur Wiederherstellung verwendet werden.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Letzte Einsätze -->
{% if einsaetze %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Letzte 50 Einsätze (alle Benutzer)</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Datum</th>
                                <th>Benutzer</th>
                                <th>Maschine</th>
                                <th>Zweck</th>
                                <th>Stunden</th>
                                <th>Treibstoff</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for einsatz in einsaetze[:20] %}
                            <tr>
                                <td>{{ einsatz.datum }}</td>
                                <td>{{ einsatz.benutzer }}</td>
                                <td>{{ einsatz.maschine }}</td>
                                <td><span class="badge bg-info">{{ einsatz.einsatzzweck }}</span></td>
                                <td>{{ "%.1f"|format(einsatz.betriebsstunden) }} h</td>
                                <td>
                                    {% if einsatz.treibstoffverbrauch %}
                                        {{ "%.1f"|format(einsatz.treibstoffverbrauch) }} l
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white text-center">
                <a href="{{ url_for('admin_system.admin_alle_einsaetze') }}" class="btn btn-sm btn-outline-primary">
                    Alle Einsätze anzeigen <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Backup-Bestätigungs-Modal -->
<div class="modal fade" id="backupModal" tabindex="-1" aria-labelledby="backupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="backupModalLabel">
                    <i class="bi bi-database"></i> Backup-Durchführung bestätigen
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_system.admin_backup_bestaetigen') }}">
                <div class="modal-body">
                    <p>Bitte bestätigen Sie, dass Sie ein Backup der Datenbank erstellt haben:</p>
                    <div class="mb-3">
                        <label for="bemerkung" class="form-label">Bemerkung (optional)</label>
                        <input type="text" class="form-control" id="bemerkung" name="bemerkung" 
                               placeholder="z.B. Backup auf USB-Stick gespeichert">
                    </div>
                    <div class="alert alert-info mb-0">
                        <small>
                            <i class="bi bi-info-circle"></i>
                            <strong>Backup-Pfad:</strong><br>
                            Windows: <code>C:\...\MGRSoftware\data\maschinengemeinschaft.db</code><br>
                            Docker: <code>docker cp container:/app/data/maschinengemeinschaft.db backup.db</code><br>
                            Linux: <code>/opt/maschinengemeinschaft/data/maschinengemeinschaft.db</code>
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-circle"></i> Backup bestätigen
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}
