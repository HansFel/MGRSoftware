{% extends "base.html" %}

{% block title %}Dashboard - Maschinengemeinschaft{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <h1 class="text-white mb-4">
            <i class="bi bi-speedometer2"></i> Dashboard
        </h1>
    </div>
</div>

<!-- Ungelesene Nachrichten -->
{% if ungelesene_nachrichten > 0 %}
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <h5 class="alert-heading">
                <i class="bi bi-envelope-fill"></i> Neue Nachrichten!
            </h5>
            <p class="mb-2">
                Sie haben <strong>{{ ungelesene_nachrichten }} ungelesene Nachricht{% if ungelesene_nachrichten > 1 %}en{% endif %}</strong> in Ihren Gemeinschaften.
            </p>
            <hr>
            <a href="{{ url_for('nachrichten') }}" class="btn btn-info btn-sm">
                <i class="bi bi-chat-dots"></i> Nachrichten anzeigen
            </a>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
</div>
{% endif %}

<!-- Statistik-Karten -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Anzahl Einsätze</p>
                        <h3 class="mb-0">{{ statistik.anzahl_einsaetze or 0 }}</h3>
                    </div>
                    <i class="bi bi-calendar-check" style="font-size: 2.5rem; color: #667eea;"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Betriebsstunden</p>
                        <h3 class="mb-0">{{ "%.1f"|format(statistik.gesamt_stunden or 0) }}</h3>
                    </div>
                    <i class="bi bi-clock-history" style="font-size: 2.5rem; color: #667eea;"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Treibstoff (l)</p>
                        <h3 class="mb-0">{{ "%.1f"|format(statistik.gesamt_treibstoff or 0) }}</h3>
                    </div>
                    <i class="bi bi-fuel-pump" style="font-size: 2.5rem; color: #667eea;"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Treibstoffkosten</p>
                        <h3 class="mb-0 text-danger">{{ "%.2f"|format(statistik.gesamt_kosten or 0) }}€</h3>
                    </div>
                    <i class="bi bi-fuel-pump-fill" style="font-size: 2.5rem; color: #dc3545;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card stat-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1">Maschinenkosten</p>
                        <h3 class="mb-0 text-success">{{ "%.2f"|format(statistik.gesamt_maschinenkosten or 0) }}€</h3>
                    </div>
                    <i class="bi bi-gear-fill" style="font-size: 2.5rem; color: #28a745;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card stat-card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="mb-1 opacity-75">GESAMTKOSTEN</p>
                        <h2 class="mb-0">{{ "%.2f"|format(statistik.gesamtkosten or 0) }}€</h2>
                    </div>
                    <i class="bi bi-currency-euro" style="font-size: 3rem; opacity: 0.75;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Zahlungsreferenzen -->
{% if zahlungsreferenzen %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-credit-card"></i> Ihre Zahlungsreferenzen
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-3">
                    <i class="bi bi-info-circle"></i> 
                    Verwenden Sie diese Referenznummer bei Überweisungen, damit Ihre Zahlung automatisch zugeordnet werden kann.
                </p>
                <div class="row">
                    {% for ref in zahlungsreferenzen %}
                    <div class="col-md-6 mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="text-muted mb-2">{{ ref.gemeinschaft_name }}</h6>
                                <div class="input-group">
                                    <input type="text" class="form-control form-control-lg fw-bold" 
                                           value="{{ ref.referenznummer }}" 
                                           id="ref_{{ ref.id }}" 
                                           readonly>
                                    <button class="btn btn-outline-success" type="button"
                                            onclick="copyToClipboard('ref_{{ ref.id }}', this)">
                                        <i class="bi bi-clipboard"></i> Kopieren
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function copyToClipboard(elementId, button) {
    var copyText = document.getElementById(elementId);
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(copyText.value);
    
    // Feedback
    var originalHtml = button.innerHTML;
    button.innerHTML = '<i class="bi bi-check"></i> Kopiert!';
    button.classList.remove('btn-outline-success');
    button.classList.add('btn-success');
    
    setTimeout(function() {
        button.innerHTML = originalHtml;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-success');
    }, 2000);
}
</script>
{% endif %}

<!-- Forderungen nach Gemeinschaft -->
{% if schulden_nach_gemeinschaft %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-cash-stack"></i> Meine Forderungen nach Gemeinschaft
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Gemeinschaft</th>
                                <th class="text-end">Einsätze</th>
                                <th class="text-end">Maschinenkosten</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for schuld in schulden_nach_gemeinschaft %}
                            <tr>
                                <td><strong>{{ schuld.bezeichnung }}</strong></td>
                                <td class="text-end">{{ schuld.anzahl_einsaetze }}</td>
                                <td class="text-end">
                                    <strong class="text-primary">{{ "%.2f"|format(schuld.gesamtkosten or 0) }}€</strong>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th>Gesamt</th>
                                <th class="text-end">{{ schulden_nach_gemeinschaft|sum(attribute='anzahl_einsaetze') }}</th>
                                <th class="text-end">
                                    <strong class="text-primary">{{ "%.2f"|format(schulden_nach_gemeinschaft|sum(attribute='gesamtkosten')) }}€</strong>
                                </th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Meine Reservierungen -->
{% if reservierungen %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-check"></i> Meine Reservierungen
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Datum</th>
                                <th>Maschine</th>
                                <th>Zeit</th>
                                <th>Dauer</th>
                                <th>Zweck</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for res in reservierungen %}
                            <tr>
                                <td><strong>{{ res.datum }}</strong></td>
                                <td>{{ res.maschine_bezeichnung }}</td>
                                <td>{{ res.uhrzeit_von }} - {{ res.uhrzeit_bis }} Uhr</td>
                                <td>{{ res.nutzungsdauer_stunden }} h</td>
                                <td>{{ res.zweck or '-' }}</td>
                                <td>
                                    <form method="POST" action="{{ url_for('reservierung_stornieren', reservierung_id=res.id) }}" 
                                          style="display: inline;" onsubmit="return confirm('Reservierung wirklich stornieren?');">
                                        <button type="submit" class="btn btn-sm btn-danger" title="Stornieren">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Schnellzugriff -->
<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-body text-center p-5">
                <i class="bi bi-plus-circle-fill" style="font-size: 4rem; color: #667eea;"></i>
                <h4 class="mt-3">Neuen Einsatz erfassen</h4>
                <p class="text-muted">Tragen Sie einen neuen Maschineneinsatz ein</p>
                <a href="{{ url_for('neuer_einsatz') }}" class="btn btn-primary btn-custom">
                    <i class="bi bi-plus-lg"></i> Einsatz erfassen
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-body text-center p-5">
                <i class="bi bi-list-check" style="font-size: 4rem; color: #667eea;"></i>
                <h4 class="mt-3">Meine Einsätze</h4>
                <p class="text-muted">Übersicht aller Ihrer Maschineneinsätze</p>
                <a href="{{ url_for('meine_einsaetze') }}" class="btn btn-outline-primary btn-custom">
                    <i class="bi bi-eye"></i> Einsätze anzeigen
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Letzte Einsätze -->
{% if einsaetze %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Letzte Einsätze</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Datum</th>
                                <th>Maschine</th>
                                <th>Zweck</th>
                                <th>Menge</th>
                                <th>Treibstoff</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for einsatz in einsaetze %}
                            <tr>
                                <td>{{ einsatz.datum }}</td>
                                <td>{{ einsatz.maschine }}</td>
                                <td>{{ einsatz.einsatzzweck }}</td>
                                <td>
                                    {% if einsatz.abrechnungsart == 'hektar' and einsatz.flaeche_menge %}
                                        {{ "%.2f"|format(einsatz.flaeche_menge) }} ha
                                    {% elif einsatz.abrechnungsart == 'kilometer' and einsatz.flaeche_menge %}
                                        {{ "%.2f"|format(einsatz.flaeche_menge) }} km
                                    {% elif einsatz.abrechnungsart == 'stueck' and einsatz.flaeche_menge %}
                                        {{ "%.0f"|format(einsatz.flaeche_menge) }} St
                                    {% else %}
                                        {{ "%.1f"|format(einsatz.betriebsstunden) }} h
                                    {% endif %}
                                </td>
                                <td>
                                    {% if einsatz.treibstoffverbrauch %}
                                        {{ "%.1f"|format(einsatz.treibstoffverbrauch) }} l
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
